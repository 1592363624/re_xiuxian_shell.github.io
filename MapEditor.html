<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰øÆ‰ªôÊ∏∏ÊàèÂú∞ÂõæÁºñËæëÂô®</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            position: relative;
        }

        /* ËÉåÊôØË£ÖÈ•∞ÂÖÉÁ¥† */
        .background-decoration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
            }
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            padding: 0;
        }

        .editor-panel {
            width: 30%;
            min-width: 350px;
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            display: flex;
            flex-direction: column;
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            color: white;
        }

        h1, h2 {
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.5);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .btn-success {
            background: rgba(46, 204, 113, 0.3);
            border-color: rgba(46, 204, 113, 0.5);
        }

        .btn-success:hover {
            background: rgba(46, 204, 113, 0.5);
        }

        .map-node {
            position: absolute;
            min-width: 150px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: move;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            user-select: none;
        }

        .map-node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .safe-area {
            background: rgba(212, 237, 218, 0.3);
            border: 1px solid rgba(195, 230, 203, 0.5);
        }

        .danger-area {
            background: rgba(248, 215, 218, 0.3);
            border: 1px solid rgba(245, 198, 203, 0.5);
        }

        .node-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .node-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }

        .node-npcs {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
        }

        .connection {
            position: absolute;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.5);
            transform-origin: 0 0;
            z-index: 5;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 12px solid rgba(255, 255, 255, 0.7);
        }

        .npc-list {
            margin-top: 10px;
        }

        .npc-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .npc-item input {
            margin: 5px 0;
        }

        .tools {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tools button {
            flex: 1;
            min-width: 100px;
        }

        .mode-indicator {
            padding: 8px 15px;
            background: rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid rgba(241, 196, 15, 0.5);
            backdrop-filter: blur(5px);
        }

        .json-output {
            background: rgba(44, 62, 80, 0.4);
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 150px;
        }

        /* ËøîÂõûÈ¶ñÈ°µÊåâÈíÆ */
        .back-to-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            color: white;
            font-size: 20px;
            text-decoration: none;
        }

        .back-to-home:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .editor-panel {
                width: 100%;
                height: 40%;
                min-width: auto;
            }

            .tools {
                flex-direction: column;
            }

            .tools button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- ËÉåÊôØË£ÖÈ•∞ÂÖÉÁ¥† -->
<div class="background-decoration">
    <div class="floating-element" style="width: 100px; height: 100px; top: 10%; left: 10%;"></div>
    <div class="floating-element" style="width: 150px; height: 150px; bottom: 15%; right: 10%;"></div>
    <div class="floating-element" style="width: 80px; height: 80px; top: 40%; right: 20%;"></div>
</div>

<!-- ËøîÂõûÈ¶ñÈ°µÊåâÈíÆ -->
<a href="index.html" class="back-to-home" title="ËøîÂõûÈ¶ñÈ°µ">üè†</a>

<div class="container">
    <div class="editor-panel">
        <h1>üó∫Ô∏è Âú∞ÂõæÁºñËæëÂô®</h1>

        <div class="mode-indicator" id="modeIndicator">ÂΩìÂâçÊ®°Âºè: Êü•ÁúãÊ®°Âºè</div>

        <div class="editor-content">
            <div class="form-group">
                <label for="areaName">Âå∫ÂüüÂêçÁß∞:</label>
                <input type="text" id="areaName" placeholder="ËæìÂÖ•Âå∫ÂüüÂêçÁß∞">
            </div>

            <div class="form-group">
                <label for="areaDesc">Âå∫ÂüüÊèèËø∞:</label>
                <textarea id="areaDesc" placeholder="ËæìÂÖ•Âå∫ÂüüÊèèËø∞"></textarea>
            </div>

            <div class="form-group">
                <label for="areaSafety">ÂÆâÂÖ®Âå∫Âüü:</label>
                <select id="areaSafety">
                    <option value="true">ÊòØ</option>
                    <option value="false">Âê¶</option>
                </select>
            </div>

            <div class="form-group">
                <label>NPCÂàóË°®:</label>
                <div id="npcList" class="npc-list">
                    <!-- NPCÈ°πÂ∞ÜÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
                </div>
                <button id="addNpcBtn" class="btn-success">Ê∑ªÂä†NPC</button>
            </div>

            <div class="tools">
                <button id="addAreaBtn" class="btn-success">Ê∑ªÂä†Âå∫Âüü</button>
                <button id="updateAreaBtn">Êõ¥Êñ∞Âå∫Âüü</button>
                <button id="deleteAreaBtn" class="btn-danger">Âà†Èô§Âå∫Âüü</button>
                <button id="connectModeBtn">ËøûÊé•Ê®°Âºè</button>
            </div>

            <div class="form-group">
                <label>Áõ∏ÈÇªÂå∫Âüü:</label>
                <div id="adjacentAreas">
                    <!-- Áõ∏ÈÇªÂå∫ÂüüÂ∞ÜÂä®ÊÄÅÊòæÁ§∫Âú®ËøôÈáå -->
                </div>
            </div>

            <h2>Âú∞ÂõæJSONÈÖçÁΩÆ</h2>
            <div id="jsonOutput" class="json-output"></div>

            <div class="tools">
                <button id="exportBtn">ÂØºÂá∫ÈÖçÁΩÆ</button>
                <button id="importBtn">ÂØºÂÖ•ÈÖçÁΩÆ</button>
                <input type="file" id="importFile" style="display: none;" accept=".json">
            </div>
        </div>
    </div>

    <div class="map-container" id="mapContainer">
        <!-- Âú∞ÂõæËäÇÁÇπÂ∞ÜÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
    </div>
</div>

<script>
    // ÂàùÂßãÂú∞ÂõæÊï∞ÊçÆ
    let mapData = {
        "Èùí‰∫ëÈïá": {
            "ÊèèËø∞": "‰∏Ä‰∏™ÂÆÅÈùôÁöÑÂ∞èÈïáÔºåÊòØ‰øÆ‰ªôËÄÖÂàùÂÖ•‰ªôÈÄîÁöÑÁ¨¨‰∏ÄÁ´ô„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Èùí‰∫ëÂ±±ËÑâ", "Áø†Á´πÊûó"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 100, "y": 300},
            "NPC": [
                {"ÂêçÁß∞": "ÈïáÈïøÁéãÂ§ßÈî§", "Á±ªÂûã": "‰ªªÂä°ÂèëÂ∏ÉËÄÖ"},
                {"ÂêçÁß∞": "ËçØÂ∫óËÄÅÊùøÊùéÂ§ßÂ§´", "Á±ªÂûã": "ÂïÜ‰∫∫"}
            ]
        },
        "Èùí‰∫ëÂ±±ËÑâ": {
            "ÊèèËø∞": "Èùí‰∫ëÈïáÂë®ËæπÁöÑÂ±±ËÑâÔºåÁÅµÊ∞îÊµìÈÉÅÔºåÈÄÇÂêàÂàùÂ≠¶ËÄÖ‰øÆÁÇº„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Èùí‰∫ëÈïá", "Áø†Á´πÊûó", "ÈªëÈ£éÂØ®"],
            "ÂÆâÂÖ®Âå∫Âüü": false,
            "‰ΩçÁΩÆ": {"x": 300, "y": 200},
            "NPC": [
                {"ÂêçÁß∞": "ÈááËçØ‰∫∫Â∞è‰∫å", "Á±ªÂûã": "ÊùêÊñôÂïÜ‰∫∫"}
            ]
        },
        "Áø†Á´πÊûó": {
            "ÊèèËø∞": "‰∏ÄÁâáÁø†ÁªøÁöÑÁ´πÊûóÔºåÁéØÂ¢ÉÊ∏ÖÂπΩÔºåÊòØ‰øÆÁÇºÂøÉÂ¢ÉÁöÑÂ•ΩÂú∞Êñπ„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Èùí‰∫ëÈïá", "Èùí‰∫ëÂ±±ËÑâ", "Êó†ÂêçÊ¥ûÂ∫ú"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 200, "y": 450},
            "NPC": [
                {"ÂêçÁß∞": "Á´πÁøÅ", "Á±ªÂûã": "ÈöêÂ£´"}
            ]
        },
        "ÈªëÈ£éÂØ®": {
            "ÊèèËø∞": "Â±±Ë¥ºÁõòË∏û‰πãÂú∞ÔºåÂç±Èô©ÈáçÈáçÔºå‰ΩÜÊú∫Áºò‰πüÂ§ö„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Èùí‰∫ëÂ±±ËÑâ", "ËçíÂè§ÊàòÂú∫"],
            "ÂÆâÂÖ®Âå∫Âüü": false,
            "‰ΩçÁΩÆ": {"x": 500, "y": 150},
            "NPC": [
                {"ÂêçÁß∞": "ÈªëÈ£éÂØ®‰∏ª", "Á±ªÂûã": "ÊïåÂØπBoss"}
            ]
        },
        "Êó†ÂêçÊ¥ûÂ∫ú": {
            "ÊèèËø∞": "‰∏ÄÂ§ÑÂè§ËÄÅÁöÑÊ¥ûÂ∫úÔºåÊçÆËØ¥ËóèÊúâÂâç‰∫∫Áïô‰∏ãÁöÑÂÆùÁâ©„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Áø†Á´πÊûó", "ËçíÂè§ÊàòÂú∫"],
            "ÂÆâÂÖ®Âå∫Âüü": false,
            "‰ΩçÁΩÆ": {"x": 400, "y": 400},
            "NPC": [
                {"ÂêçÁß∞": "Ê¥ûÂ∫úÂÆàÊä§ËÄÖ", "Á±ªÂûã": "Á≤æËã±ÊÄ™Áâ©"}
            ]
        },
        "ËçíÂè§ÊàòÂú∫": {
            "ÊèèËø∞": "ËøúÂè§Êó∂Êúü‰ªôÈ≠îÂ§ßÊàòÁöÑÊàòÂú∫ÔºåÊÆãÁïôÁùÄÂº∫Â§ßÁöÑÊ∞îÊÅØ„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["ÈªëÈ£éÂØ®", "Êó†ÂêçÊ¥ûÂ∫ú", "Â§©ÂâëÂÆó"],
            "ÂÆâÂÖ®Âå∫Âüü": false,
            "‰ΩçÁΩÆ": {"x": 700, "y": 300},
            "NPC": [
                {"ÂêçÁß∞": "ÊàòÂú∫Ê∏∏È≠Ç", "Á±ªÂûã": "ÊôÆÈÄöÊÄ™Áâ©"}
            ]
        },
        "Â§©ÂâëÂÆó": {
            "ÊèèËø∞": "Ê≠£ÈÅì‰∏âÂ§ßÂÆóÈó®‰πã‰∏ÄÔºåÂâë‰øÆÂú£Âú∞„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["ËçíÂè§ÊàòÂú∫", "Ë°ÄÂàÄÈó®"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 900, "y": 200},
            "NPC": [
                {"ÂêçÁß∞": "ÊéåÈó®Â§©ÂâëËÄÅ‰∫∫", "Á±ªÂûã": "ÂÆóÈó®ÊéåÈó®"},
                {"ÂêçÁß∞": "Ââë‰æç", "Á±ªÂûã": "ÂÆóÈó®ÂÆàÂç´"}
            ]
        },
        "Ë°ÄÂàÄÈó®": {
            "ÊèèËø∞": "È≠îÈÅì‰∏âÂ§ßÂÆóÈó®‰πã‰∏ÄÔºå‰ª•ÂàÄÊ≥ïÂíåË°ÄÁ•≠ÈóªÂêç„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Â§©ÂâëÂÆó", "‰∏áÊØíÈó®"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 1100, "y": 350},
            "NPC": [
                {"ÂêçÁß∞": "Èó®‰∏ªË°ÄÊó†Ê∂Ø", "Á±ªÂûã": "ÂÆóÈó®ÊéåÈó®"}
            ]
        },
        "‰∏áÊØíÈó®": {
            "ÊèèËø∞": "ÈÇ™ÈÅìÂÆóÈó®Ôºå‰∏ìÁ≤æÊØíÁâ©ÂíåËõäÊúØ„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["Ë°ÄÂàÄÈó®", "ÊòÜ‰ªë‰ªôÂ¢É"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 900, "y": 500},
            "NPC": [
                {"ÂêçÁß∞": "Âú£Â•≥ÊØí‰ªôÂ≠ê", "Á±ªÂûã": "ÂÆóÈó®Âú£Â•≥"}
            ]
        },
        "ÊòÜ‰ªë‰ªôÂ¢É": {
            "ÊèèËø∞": "‰º†ËØ¥‰∏≠ÁöÑ‰ªôÁïåÂÖ•Âè£ÔºåÂè™ÊúâËææÂà∞‰∏ÄÂÆöÂ¢ÉÁïåÊâçËÉΩËøõÂÖ•„ÄÇ",
            "Áõ∏ÈÇªÂå∫Âüü": ["‰∏áÊØíÈó®"],
            "ÂÆâÂÖ®Âå∫Âüü": true,
            "‰ΩçÁΩÆ": {"x": 1100, "y": 600},
            "NPC": [
                {"ÂêçÁß∞": "‰ªôÁ´•", "Á±ªÂûã": "‰ªô‰∫∫"}
            ]
        }
    };

    // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂå∫Âüü
    let selectedArea = null;
    // ËøûÊé•Ê®°ÂºèÁä∂ÊÄÅ
    let connectMode = false;
    // ËøûÊé•Ëµ∑ÁÇπ
    let connectStart = null;

    // DOMÂÖÉÁ¥†
    const mapContainer = document.getElementById('mapContainer');
    const areaNameInput = document.getElementById('areaName');
    const areaDescInput = document.getElementById('areaDesc');
    const areaSafetySelect = document.getElementById('areaSafety');
    const npcListDiv = document.getElementById('npcList');
    const adjacentAreasDiv = document.getElementById('adjacentAreas');
    const jsonOutputDiv = document.getElementById('jsonOutput');
    const modeIndicator = document.getElementById('modeIndicator');

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function () {
        renderMap();
        updateJsonOutput();

        // ‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('addAreaBtn').addEventListener('click', addNewArea);
        document.getElementById('updateAreaBtn').addEventListener('click', updateArea);
        document.getElementById('deleteAreaBtn').addEventListener('click', deleteArea);
        document.getElementById('connectModeBtn').addEventListener('click', toggleConnectMode);
        document.getElementById('addNpcBtn').addEventListener('click', addNpc);
        document.getElementById('exportBtn').addEventListener('click', exportConfig);
        document.getElementById('importBtn').addEventListener('click', triggerImport);
        document.getElementById('importFile').addEventListener('change', importConfig);

        // ÂàõÂª∫Êõ¥Â§öÊµÆÂä®ÂÖÉÁ¥†
        createFloatingElements();
    });

    // ÂàõÂª∫Êõ¥Â§öÊµÆÂä®ÂÖÉÁ¥†
    function createFloatingElements() {
        const decoration = document.querySelector('.background-decoration');
        for (let i = 0; i < 5; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.style.width = Math.random() * 60 + 20 + 'px';
            element.style.height = element.style.width;
            element.style.top = Math.random() * 100 + '%';
            element.style.left = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 5 + 's';
            element.style.opacity = Math.random() * 0.1 + 0.05;
            decoration.appendChild(element);
        }
    }

    // Ê∏≤ÊüìÂú∞Âõæ
    function renderMap() {
        // Ê∏ÖÁ©∫Âú∞ÂõæÂÆπÂô®
        mapContainer.innerHTML = '';

        // ÂÖàÁªòÂà∂ËøûÊé•Á∫ø
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.Áõ∏ÈÇªÂå∫Âüü) {
                area.Áõ∏ÈÇªÂå∫Âüü.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].‰ΩçÁΩÆ) {
                        drawConnection(area.‰ΩçÁΩÆ, mapData[adjacent].‰ΩçÁΩÆ, areaName, adjacent);
                    }
                });
            }
        }

        // ÂÜçÁªòÂà∂Âå∫ÂüüËäÇÁÇπ
        for (const areaName in mapData) {
            const area = mapData[areaName];
            createAreaNode(areaName, area);
        }
    }

    // ÂàõÂª∫Âå∫ÂüüËäÇÁÇπ
    function createAreaNode(name, data) {
        const node = document.createElement('div');
        node.className = `map-node ${data.ÂÆâÂÖ®Âå∫Âüü ? 'safe-area' : 'danger-area'}`;
        node.style.left = `${data.‰ΩçÁΩÆ.x}px`;
        node.style.top = `${data.‰ΩçÁΩÆ.y}px`;
        node.setAttribute('data-name', name);
        node.setAttribute('draggable', 'true');

        node.innerHTML = `
                <div class="node-name">${name}</div>
                <div class="node-desc">${data.ÊèèËø∞}</div>
                <div class="node-npcs">${data.NPC.length}‰∏™NPC</div>
            `;

        // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
        node.addEventListener('click', function (e) {
            e.stopPropagation();
            selectArea(name);

            // Â¶ÇÊûúÂú®ËøûÊé•Ê®°ÂºèÔºåÂ§ÑÁêÜËøûÊé•
            if (connectMode) {
                if (connectStart === null) {
                    connectStart = name;
                    modeIndicator.textContent = `ÂΩìÂâçÊ®°Âºè: ËøûÊé•Ê®°Âºè - Â∑≤ÈÄâÊã©Ëµ∑ÁÇπ: ${name}`;
                } else {
                    if (connectStart !== name) {
                        createConnection(connectStart, name);
                    }
                    connectStart = null;
                    modeIndicator.textContent = 'ÂΩìÂâçÊ®°Âºè: ËøûÊé•Ê®°Âºè - ËØ∑ÈÄâÊã©Ëµ∑ÁÇπ';
                }
            }
        });

        // Ê∑ªÂä†ÊãñÊãΩÂäüËÉΩ
        makeDraggable(node, name);

        mapContainer.appendChild(node);
    }

    // ‰ΩøËäÇÁÇπÂèØÊãñÊãΩ
    function makeDraggable(element, areaName) {
        let isDragging = false;
        let offsetX, offsetY;

        element.addEventListener('mousedown', function (e) {
            isDragging = true;
            offsetX = e.clientX - element.getBoundingClientRect().left;
            offsetY = e.clientY - element.getBoundingClientRect().top;
            element.style.zIndex = "100";
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;

            const mapRect = mapContainer.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();

            let x = e.clientX - mapRect.left - offsetX;
            let y = e.clientY - mapRect.top - offsetY;

            // ÈôêÂà∂ÊãñÊãΩËåÉÂõ¥
            x = Math.max(0, Math.min(x, mapRect.width - elementRect.width));
            y = Math.max(0, Math.min(y, mapRect.height - elementRect.height));

            element.style.left = x + 'px';
            element.style.top = y + 'px';

            // Êõ¥Êñ∞Êï∞ÊçÆ
            mapData[areaName].‰ΩçÁΩÆ.x = x;
            mapData[areaName].‰ΩçÁΩÆ.y = y;

            // Êõ¥Êñ∞ËøûÊé•Á∫ø
            updateConnections();
        });

        document.addEventListener('mouseup', function () {
            if (isDragging) {
                isDragging = false;
                element.style.zIndex = "10";
                updateJsonOutput();
            }
        });
    }

    // ÁªòÂà∂ËøûÊé•Á∫ø
    function drawConnection(startPos, endPos, startName, endName) {
        // ËÆ°ÁÆóËøûÁ∫øÈïøÂ∫¶ÂíåËßíÂ∫¶
        const dx = endPos.x - startPos.x;
        const dy = endPos.y - startPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

        // ÂàõÂª∫ËøûÁ∫ø
        const connection = document.createElement('div');
        connection.className = 'connection';
        connection.style.width = `${length}px`;
        connection.style.left = `${startPos.x}px`;
        connection.style.top = `${startPos.y}px`;
        connection.style.transform = `rotate(${angle}deg)`;

        // ÂàõÂª∫ÁÆ≠Â§¥
        const arrow = document.createElement('div');
        arrow.className = 'connection-arrow';
        arrow.style.left = `${length - 5}px`;
        arrow.style.top = `-4px`;
        arrow.style.transform = `rotate(${angle}deg)`;

        connection.appendChild(arrow);
        connection.setAttribute('data-connection', `${startName}-${endName}`);
        mapContainer.appendChild(connection);
    }

    // Êõ¥Êñ∞ÊâÄÊúâËøûÊé•Á∫ø
    function updateConnections() {
        // ÁßªÈô§ÊâÄÊúâÁé∞ÊúâËøûÊé•Á∫ø
        document.querySelectorAll('.connection').forEach(conn => {
            conn.remove();
        });

        // ÈáçÊñ∞ÁªòÂà∂ÊâÄÊúâËøûÊé•Á∫ø
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.Áõ∏ÈÇªÂå∫Âüü) {
                area.Áõ∏ÈÇªÂå∫Âüü.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].‰ΩçÁΩÆ) {
                        drawConnection(area.‰ΩçÁΩÆ, mapData[adjacent].‰ΩçÁΩÆ, areaName, adjacent);
                    }
                });
            }
        }
    }

    // ÈÄâÊã©Âå∫Âüü
    function selectArea(name) {
        selectedArea = name;
        const area = mapData[name];

        // Êõ¥Êñ∞Ë°®Âçï
        areaNameInput.value = name;
        areaDescInput.value = area.ÊèèËø∞;
        areaSafetySelect.value = area.ÂÆâÂÖ®Âå∫Âüü;

        // Êõ¥Êñ∞NPCÂàóË°®
        updateNpcList(area.NPC);

        // Êõ¥Êñ∞Áõ∏ÈÇªÂå∫ÂüüÊòæÁ§∫
        updateAdjacentAreas(name);

        // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑËäÇÁÇπ
        document.querySelectorAll('.map-node').forEach(node => {
            node.style.boxShadow = node.getAttribute('data-name') === name ?
                '0 0 0 3px #3498db, 0 0 15px rgba(52, 152, 219, 0.7)' : '0 4px 15px rgba(0, 0, 0, 0.2)';
        });
    }

    // Êõ¥Êñ∞NPCÂàóË°®ÊòæÁ§∫
    function updateNpcList(npcs) {
        npcListDiv.innerHTML = '';

        npcs.forEach((npc, index) => {
            const npcItem = document.createElement('div');
            npcItem.className = 'npc-item';
            npcItem.innerHTML = `
                    <div>ÂêçÁß∞: <input type="text" value="${npc.ÂêçÁß∞}" data-index="${index}" class="npc-name"></div>
                    <div>Á±ªÂûã: <input type="text" value="${npc.Á±ªÂûã}" data-index="${index}" class="npc-type"></div>
                    <button class="btn-danger delete-npc" data-index="${index}">Âà†Èô§</button>
                `;
            npcListDiv.appendChild(npcItem);
        });

        // Ê∑ªÂä†Âà†Èô§NPCÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.querySelectorAll('.delete-npc').forEach(btn => {
            btn.addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                deleteNpc(index);
            });
        });

        // Ê∑ªÂä†NPCÂ≠óÊÆµÊõ¥ÊîπÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.querySelectorAll('.npc-name, .npc-type').forEach(input => {
            input.addEventListener('change', function () {
                const index = parseInt(this.getAttribute('data-index'));
                updateNpcField(index, this.className, this.value);
            });
        });
    }

    // Êõ¥Êñ∞Áõ∏ÈÇªÂå∫ÂüüÊòæÁ§∫
    function updateAdjacentAreas(areaName) {
        adjacentAreasDiv.innerHTML = '';
        const area = mapData[areaName];

        area.Áõ∏ÈÇªÂå∫Âüü.forEach(adjacent => {
            const adjItem = document.createElement('div');
            adjItem.className = 'npc-item';
            adjItem.innerHTML = `
                    <span>${adjacent}</span>
                    <button class="btn-danger delete-adjacent" data-adjacent="${adjacent}">Âà†Èô§ËøûÊé•</button>
                `;
            adjacentAreasDiv.appendChild(adjItem);
        });

        // Ê∑ªÂä†Âà†Èô§Áõ∏ÈÇªÂå∫ÂüüÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.querySelectorAll('.delete-adjacent').forEach(btn => {
            btn.addEventListener('click', function () {
                const adjacent = this.getAttribute('data-adjacent');
                deleteConnection(areaName, adjacent);
            });
        });
    }

    // Ê∑ªÂä†Êñ∞Âå∫Âüü
    function addNewArea() {
        const name = areaNameInput.value.trim();
        if (!name) {
            alert('ËØ∑ËæìÂÖ•Âå∫ÂüüÂêçÁß∞');
            return;
        }

        if (mapData[name]) {
            alert('Âå∫ÂüüÂêçÁß∞Â∑≤Â≠òÂú®');
            return;
        }

        // ÂàõÂª∫Êñ∞Âå∫Âüü
        mapData[name] = {
            "ÊèèËø∞": areaDescInput.value,
            "Áõ∏ÈÇªÂå∫Âüü": [],
            "ÂÆâÂÖ®Âå∫Âüü": areaSafetySelect.value === "true",
            "‰ΩçÁΩÆ": {
                "x": Math.random() * (mapContainer.offsetWidth - 200) + 100,
                "y": Math.random() * (mapContainer.offsetHeight - 200) + 100
            },
            "NPC": []
        };

        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
        renderMap();
        updateJsonOutput();

        // ÈÄâÊã©Êñ∞Âå∫Âüü
        selectArea(name);
    }

    // Êõ¥Êñ∞Âå∫Âüü
    function updateArea() {
        if (!selectedArea) {
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Âå∫Âüü');
            return;
        }

        const name = areaNameInput.value.trim();
        if (!name) {
            alert('Âå∫ÂüüÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
            return;
        }

        // Â¶ÇÊûúÂêçÁß∞ÊîπÂèò‰∫ÜÔºåÈúÄË¶ÅÊõ¥Êñ∞Êï∞ÊçÆÁªìÊûÑ
        if (name !== selectedArea) {
            // Ê£ÄÊü•Êñ∞ÂêçÁß∞ÊòØÂê¶Â∑≤Â≠òÂú®
            if (mapData[name]) {
                alert('Âå∫ÂüüÂêçÁß∞Â∑≤Â≠òÂú®');
                return;
            }

            // Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÈÇªÂå∫Âüü‰∏≠ÁöÑÂºïÁî®
            for (const area in mapData) {
                const index = mapData[area].Áõ∏ÈÇªÂå∫Âüü.indexOf(selectedArea);
                if (index !== -1) {
                    mapData[area].Áõ∏ÈÇªÂå∫Âüü[index] = name;
                }
            }

            // ÁßªÂä®Êï∞ÊçÆÂà∞Êñ∞ÈîÆ
            mapData[name] = mapData[selectedArea];
            delete mapData[selectedArea];

            selectedArea = name;
        }

        // Êõ¥Êñ∞Âå∫ÂüüÂ±ûÊÄß
        mapData[name].ÊèèËø∞ = areaDescInput.value;
        mapData[name].ÂÆâÂÖ®Âå∫Âüü = areaSafetySelect.value === "true";

        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
        renderMap();
        updateJsonOutput();
    }

    // Âà†Èô§Âå∫Âüü
    function deleteArea() {
        if (!selectedArea) {
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Âå∫Âüü');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Âå∫Âüü"${selectedArea}"ÂêóÔºü`)) {
            return;
        }

        // ‰ªéÊâÄÊúâÁõ∏ÈÇªÂå∫Âüü‰∏≠ÁßªÈô§ÂºïÁî®
        for (const area in mapData) {
            const index = mapData[area].Áõ∏ÈÇªÂå∫Âüü.indexOf(selectedArea);
            if (index !== -1) {
                mapData[area].Áõ∏ÈÇªÂå∫Âüü.splice(index, 1);
            }
        }

        // Âà†Èô§Âå∫Âüü
        delete mapData[selectedArea];

        // ÈáçÁΩÆË°®Âçï
        areaNameInput.value = '';
        areaDescInput.value = '';
        areaSafetySelect.value = 'true';
        npcListDiv.innerHTML = '';
        adjacentAreasDiv.innerHTML = '';
        selectedArea = null;

        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
        renderMap();
        updateJsonOutput();
    }

    // ÂàáÊç¢ËøûÊé•Ê®°Âºè
    function toggleConnectMode() {
        connectMode = !connectMode;
        connectStart = null;

        if (connectMode) {
            modeIndicator.textContent = 'ÂΩìÂâçÊ®°Âºè: ËøûÊé•Ê®°Âºè - ËØ∑ÈÄâÊã©Ëµ∑ÁÇπ';
            modeIndicator.style.background = 'rgba(241, 196, 15, 0.3)';
        } else {
            modeIndicator.textContent = 'ÂΩìÂâçÊ®°Âºè: Êü•ÁúãÊ®°Âºè';
            modeIndicator.style.background = 'rgba(46, 204, 113, 0.3)';
        }
    }

    // ÂàõÂª∫ËøûÊé•
    function createConnection(start, end) {
        if (!mapData[start].Áõ∏ÈÇªÂå∫Âüü.includes(end)) {
            mapData[start].Áõ∏ÈÇªÂå∫Âüü.push(end);
        }

        if (!mapData[end].Áõ∏ÈÇªÂå∫Âüü.includes(start)) {
            mapData[end].Áõ∏ÈÇªÂå∫Âüü.push(start);
        }

        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
        renderMap();
        updateJsonOutput();

        // Êõ¥Êñ∞Áõ∏ÈÇªÂå∫ÂüüÊòæÁ§∫
        if (selectedArea === start || selectedArea === end) {
            updateAdjacentAreas(selectedArea);
        }
    }

    // Âà†Èô§ËøûÊé•
    function deleteConnection(area1, area2) {
        const index1 = mapData[area1].Áõ∏ÈÇªÂå∫Âüü.indexOf(area2);
        if (index1 !== -1) {
            mapData[area1].Áõ∏ÈÇªÂå∫Âüü.splice(index1, 1);
        }

        const index2 = mapData[area2].Áõ∏ÈÇªÂå∫Âüü.indexOf(area1);
        if (index2 !== -1) {
            mapData[area2].Áõ∏ÈÇªÂå∫Âüü.splice(index2, 1);
        }

        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
        renderMap();
        updateJsonOutput();

        // Êõ¥Êñ∞Áõ∏ÈÇªÂå∫ÂüüÊòæÁ§∫
        updateAdjacentAreas(selectedArea);
    }

    // Ê∑ªÂä†NPC
    function addNpc() {
        if (!selectedArea) {
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Âå∫Âüü');
            return;
        }

        mapData[selectedArea].NPC.push({
            "ÂêçÁß∞": "Êñ∞NPC",
            "Á±ªÂûã": "NPCÁ±ªÂûã"
        });

        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // Âà†Èô§NPC
    function deleteNpc(index) {
        if (!selectedArea) return;

        mapData[selectedArea].NPC.splice(index, 1);
        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // Êõ¥Êñ∞NPCÂ≠óÊÆµ
    function updateNpcField(index, field, value) {
        if (!selectedArea) return;

        const fieldName = field === 'npc-name' ? 'ÂêçÁß∞' : 'Á±ªÂûã';
        mapData[selectedArea].NPC[index][fieldName] = value;
        updateJsonOutput();
    }

    // Êõ¥Êñ∞JSONËæìÂá∫
    function updateJsonOutput() {
        // ÂàõÂª∫‰∏çÂê´‰ΩçÁΩÆ‰ø°ÊÅØÁöÑÂâØÊú¨
        const outputData = {};
        for (const area in mapData) {
            outputData[area] = {...mapData[area]};
            delete outputData[area].‰ΩçÁΩÆ;
        }

        jsonOutputDiv.textContent = JSON.stringify({"Âú∞Âõæ": outputData}, null, 2);
    }

    // ÂØºÂá∫ÈÖçÁΩÆ
    function exportConfig() {
        const dataStr = JSON.stringify({"Âú∞Âõæ": mapData}, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'game_map.json';
        link.click();
    }

    // Ëß¶ÂèëÂØºÂÖ•
    function triggerImport() {
        document.getElementById('importFile').click();
    }

    // ÂØºÂÖ•ÈÖçÁΩÆ
    function importConfig(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.Âú∞Âõæ) {
                    // ‰∏∫ÂØºÂÖ•ÁöÑÊï∞ÊçÆÊ∑ªÂä†‰ΩçÁΩÆ‰ø°ÊÅØÔºàÂ¶ÇÊûúÁº∫Â§±Ôºâ
                    for (const area in importedData.Âú∞Âõæ) {
                        if (!importedData.Âú∞Âõæ[area].‰ΩçÁΩÆ) {
                            importedData.Âú∞Âõæ[area].‰ΩçÁΩÆ = {
                                x: Math.random() * (mapContainer.offsetWidth - 200) + 100,
                                y: Math.random() * (mapContainer.offsetHeight - 200) + 100
                            };
                        }
                    }

                    mapData = importedData.Âú∞Âõæ;
                    renderMap();
                    updateJsonOutput();

                    // ÈáçÁΩÆÈÄâÊã©
                    selectedArea = null;
                    areaNameInput.value = '';
                    areaDescInput.value = '';
                    areaSafetySelect.value = 'true';
                    npcListDiv.innerHTML = '';
                    adjacentAreasDiv.innerHTML = '';

                    alert('ÈÖçÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                } else {
                    alert('Êó†ÊïàÁöÑÂú∞ÂõæÈÖçÁΩÆÊ†ºÂºè');
                }
            } catch (error) {
                alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message);
            }
        };
        reader.readAsText(file);

        // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
        event.target.value = '';
    }
</script>
</body>
</html>