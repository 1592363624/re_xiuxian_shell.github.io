<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙游戏地图编辑器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .editor-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            flex: 2;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            position: relative;
            overflow: auto;
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #2ecc71;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .map-node {
            position: absolute;
            min-width: 150px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: move;
            z-index: 10;
        }

        .safe-area {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
        }

        .danger-area {
            background-color: #f8d7da;
            border: 2px solid #f5c6cb;
        }

        .node-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .node-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .node-npcs {
            font-size: 11px;
            color: #888;
        }

        .connection {
            position: absolute;
            height: 2px;
            background-color: #7f8c8d;
            transform-origin: 0 0;
            z-index: 5;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 10px solid #7f8c8d;
        }

        .npc-list {
            margin-top: 10px;
        }

        .npc-item {
            background: #f8f9fa;
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .tools {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .mode-indicator {
            padding: 5px 10px;
            background: #f1c40f;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .json-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="editor-panel">
        <h1>修仙游戏地图编辑器</h1>

        <div class="mode-indicator" id="modeIndicator">当前模式: 查看模式</div>

        <div class="form-group">
            <label for="areaName">区域名称:</label>
            <input type="text" id="areaName" placeholder="输入区域名称">
        </div>

        <div class="form-group">
            <label for="areaDesc">区域描述:</label>
            <textarea id="areaDesc" placeholder="输入区域描述"></textarea>
        </div>

        <div class="form-group">
            <label for="areaSafety">安全区域:</label>
            <select id="areaSafety">
                <option value="true">是</option>
                <option value="false">否</option>
            </select>
        </div>

        <div class="form-group">
            <label>NPC列表:</label>
            <div id="npcList" class="npc-list">
                <!-- NPC项将动态添加到这里 -->
            </div>
            <button id="addNpcBtn" class="btn-success">添加NPC</button>
        </div>

        <div class="tools">
            <button id="addAreaBtn" class="btn-success">添加区域</button>
            <button id="updateAreaBtn">更新区域</button>
            <button id="deleteAreaBtn" class="btn-danger">删除区域</button>
            <button id="connectModeBtn">连接模式</button>
        </div>

        <div class="form-group">
            <label>相邻区域:</label>
            <div id="adjacentAreas">
                <!-- 相邻区域将动态显示在这里 -->
            </div>
        </div>

        <h2>地图JSON配置</h2>
        <div id="jsonOutput" class="json-output"></div>

        <div class="tools">
            <button id="exportBtn">导出配置</button>
            <button id="importBtn">导入配置</button>
            <input type="file" id="importFile" style="display: none;" accept=".json">
        </div>
    </div>

    <div class="map-container" id="mapContainer">
        <!-- 地图节点将动态添加到这里 -->
    </div>
</div>

<script>
    // 初始地图数据
    let mapData = {
        "青云镇": {
            "描述": "一个宁静的小镇，是修仙者初入仙途的第一站。",
            "相邻区域": ["青云山脉", "翠竹林"],
            "安全区域": true,
            "位置": {"x": 100, "y": 300},
            "NPC": [
                {"名称": "镇长王大锤", "类型": "任务发布者"},
                {"名称": "药店老板李大夫", "类型": "商人"}
            ]
        },
        "青云山脉": {
            "描述": "青云镇周边的山脉，灵气浓郁，适合初学者修炼。",
            "相邻区域": ["青云镇", "翠竹林", "黑风寨"],
            "安全区域": false,
            "位置": {"x": 300, "y": 200},
            "NPC": [
                {"名称": "采药人小二", "类型": "材料商人"}
            ]
        },
        "翠竹林": {
            "描述": "一片翠绿的竹林，环境清幽，是修炼心境的好地方。",
            "相邻区域": ["青云镇", "青云山脉", "无名洞府"],
            "安全区域": true,
            "位置": {"x": 200, "y": 450},
            "NPC": [
                {"名称": "竹翁", "类型": "隐士"}
            ]
        },
        "黑风寨": {
            "描述": "山贼盘踞之地，危险重重，但机缘也多。",
            "相邻区域": ["青云山脉", "荒古战场"],
            "安全区域": false,
            "位置": {"x": 500, "y": 150},
            "NPC": [
                {"名称": "黑风寨主", "类型": "敌对Boss"}
            ]
        },
        "无名洞府": {
            "描述": "一处古老的洞府，据说藏有前人留下的宝物。",
            "相邻区域": ["翠竹林", "荒古战场"],
            "安全区域": false,
            "位置": {"x": 400, "y": 400},
            "NPC": [
                {"名称": "洞府守护者", "类型": "精英怪物"}
            ]
        },
        "荒古战场": {
            "描述": "远古时期仙魔大战的战场，残留着强大的气息。",
            "相邻区域": ["黑风寨", "无名洞府", "天剑宗"],
            "安全区域": false,
            "位置": {"x": 700, "y": 300},
            "NPC": [
                {"名称": "战场游魂", "类型": "普通怪物"}
            ]
        },
        "天剑宗": {
            "描述": "正道三大宗门之一，剑修圣地。",
            "相邻区域": ["荒古战场", "血刀门"],
            "安全区域": true,
            "位置": {"x": 900, "y": 200},
            "NPC": [
                {"名称": "掌门天剑老人", "类型": "宗门掌门"},
                {"名称": "剑侍", "类型": "宗门守卫"}
            ]
        },
        "血刀门": {
            "描述": "魔道三大宗门之一，以刀法和血祭闻名。",
            "相邻区域": ["天剑宗", "万毒门"],
            "安全区域": true,
            "位置": {"x": 1100, "y": 350},
            "NPC": [
                {"名称": "门主血无涯", "类型": "宗门掌门"}
            ]
        },
        "万毒门": {
            "描述": "邪道宗门，专精毒物和蛊术。",
            "相邻区域": ["血刀门", "昆仑仙境"],
            "安全区域": true,
            "位置": {"x": 900, "y": 500},
            "NPC": [
                {"名称": "圣女毒仙子", "类型": "宗门圣女"}
            ]
        },
        "昆仑仙境": {
            "描述": "传说中的仙界入口，只有达到一定境界才能进入。",
            "相邻区域": ["万毒门"],
            "安全区域": true,
            "位置": {"x": 1100, "y": 600},
            "NPC": [
                {"名称": "仙童", "类型": "仙人"}
            ]
        }
    };

    // 当前选中的区域
    let selectedArea = null;
    // 连接模式状态
    let connectMode = false;
    // 连接起点
    let connectStart = null;

    // DOM元素
    const mapContainer = document.getElementById('mapContainer');
    const areaNameInput = document.getElementById('areaName');
    const areaDescInput = document.getElementById('areaDesc');
    const areaSafetySelect = document.getElementById('areaSafety');
    const npcListDiv = document.getElementById('npcList');
    const adjacentAreasDiv = document.getElementById('adjacentAreas');
    const jsonOutputDiv = document.getElementById('jsonOutput');
    const modeIndicator = document.getElementById('modeIndicator');

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        renderMap();
        updateJsonOutput();

        // 事件监听
        document.getElementById('addAreaBtn').addEventListener('click', addNewArea);
        document.getElementById('updateAreaBtn').addEventListener('click', updateArea);
        document.getElementById('deleteAreaBtn').addEventListener('click', deleteArea);
        document.getElementById('connectModeBtn').addEventListener('click', toggleConnectMode);
        document.getElementById('addNpcBtn').addEventListener('click', addNpc);
        document.getElementById('exportBtn').addEventListener('click', exportConfig);
        document.getElementById('importBtn').addEventListener('click', triggerImport);
        document.getElementById('importFile').addEventListener('change', importConfig);
    });

    // 渲染地图
    function renderMap() {
        // 清空地图容器
        mapContainer.innerHTML = '';

        // 先绘制连接线
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.相邻区域) {
                area.相邻区域.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].位置) {
                        drawConnection(area.位置, mapData[adjacent].位置, areaName, adjacent);
                    }
                });
            }
        }

        // 再绘制区域节点
        for (const areaName in mapData) {
            const area = mapData[areaName];
            createAreaNode(areaName, area);
        }
    }

    // 创建区域节点
    function createAreaNode(name, data) {
        const node = document.createElement('div');
        node.className = `map-node ${data.安全区域 ? 'safe-area' : 'danger-area'}`;
        node.style.left = `${data.位置.x}px`;
        node.style.top = `${data.位置.y}px`;
        node.setAttribute('data-name', name);

        node.innerHTML = `
                <div class="node-name">${name}</div>
                <div class="node-desc">${data.描述}</div>
                <div class="node-npcs">${data.NPC.length}个NPC</div>
            `;

        // 添加事件监听
        node.addEventListener('click', function (e) {
            e.stopPropagation();
            selectArea(name);

            // 如果在连接模式，处理连接
            if (connectMode) {
                if (connectStart === null) {
                    connectStart = name;
                    modeIndicator.textContent = `当前模式: 连接模式 - 已选择起点: ${name}`;
                } else {
                    if (connectStart !== name) {
                        createConnection(connectStart, name);
                    }
                    connectStart = null;
                    modeIndicator.textContent = '当前模式: 连接模式 - 请选择起点';
                }
            }
        });

        // 添加拖拽功能
        makeDraggable(node, name);

        mapContainer.appendChild(node);
    }

    // 使节点可拖拽
    function makeDraggable(element, areaName) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        element.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // 获取鼠标初始位置
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // 计算新位置
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // 设置元素新位置
            const newX = element.offsetLeft - pos1;
            const newY = element.offsetTop - pos2;
            element.style.left = newX + "px";
            element.style.top = newY + "px";

            // 更新数据中的位置
            mapData[areaName].位置.x = newX;
            mapData[areaName].位置.y = newY;

            // 只更新连接线，不重新渲染整个地图
            updateConnections();
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            // 拖拽结束后更新JSON输出
            updateJsonOutput();
        }
    }

    // 绘制连接线
    function drawConnection(startPos, endPos, startName, endName) {
        // 计算连线长度和角度
        const dx = endPos.x - startPos.x;
        const dy = endPos.y - startPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

        // 创建连线
        const connection = document.createElement('div');
        connection.className = 'connection';
        connection.style.width = `${length}px`;
        connection.style.left = `${startPos.x}px`;
        connection.style.top = `${startPos.y}px`;
        connection.style.transform = `rotate(${angle}deg)`;

        // 创建箭头
        const arrow = document.createElement('div');
        arrow.className = 'connection-arrow';
        arrow.style.left = `${length - 5}px`;
        arrow.style.top = `-4px`;
        arrow.style.transform = `rotate(${angle}deg)`;

        connection.appendChild(arrow);
        connection.setAttribute('data-connection', `${startName}-${endName}`);
        mapContainer.appendChild(connection);
    }

    // 更新所有连接线
    function updateConnections() {
        // 移除所有现有连接线
        document.querySelectorAll('.connection').forEach(conn => {
            conn.remove();
        });

        // 重新绘制所有连接线
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.相邻区域) {
                area.相邻区域.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].位置) {
                        drawConnection(area.位置, mapData[adjacent].位置, areaName, adjacent);
                    }
                });
            }
        }
    }

    // 选择区域
    function selectArea(name) {
        selectedArea = name;
        const area = mapData[name];

        // 更新表单
        areaNameInput.value = name;
        areaDescInput.value = area.描述;
        areaSafetySelect.value = area.安全区域;

        // 更新NPC列表
        updateNpcList(area.NPC);

        // 更新相邻区域显示
        updateAdjacentAreas(name);

        // 高亮选中的节点
        document.querySelectorAll('.map-node').forEach(node => {
            node.style.boxShadow = node.getAttribute('data-name') === name ?
                '0 0 0 3px #3498db' : '0 2px 5px rgba(0,0,0,0.2)';
        });
    }

    // 更新NPC列表显示
    function updateNpcList(npcs) {
        npcListDiv.innerHTML = '';

        npcs.forEach((npc, index) => {
            const npcItem = document.createElement('div');
            npcItem.className = 'npc-item';
            npcItem.innerHTML = `
                    <div>名称: <input type="text" value="${npc.名称}" data-index="${index}" class="npc-name"></div>
                    <div>类型: <input type="text" value="${npc.类型}" data-index="${index}" class="npc-type"></div>
                    <button class="btn-danger delete-npc" data-index="${index}">删除</button>
                `;
            npcListDiv.appendChild(npcItem);
        });

        // 添加删除NPC的事件监听
        document.querySelectorAll('.delete-npc').forEach(btn => {
            btn.addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                deleteNpc(index);
            });
        });

        // 添加NPC字段更改的事件监听
        document.querySelectorAll('.npc-name, .npc-type').forEach(input => {
            input.addEventListener('change', function () {
                const index = parseInt(this.getAttribute('data-index'));
                updateNpcField(index, this.className, this.value);
            });
        });
    }

    // 更新相邻区域显示
    function updateAdjacentAreas(areaName) {
        adjacentAreasDiv.innerHTML = '';
        const area = mapData[areaName];

        area.相邻区域.forEach(adjacent => {
            const adjItem = document.createElement('div');
            adjItem.className = 'npc-item';
            adjItem.innerHTML = `
                    <span>${adjacent}</span>
                    <button class="btn-danger delete-adjacent" data-adjacent="${adjacent}">删除连接</button>
                `;
            adjacentAreasDiv.appendChild(adjItem);
        });

        // 添加删除相邻区域的事件监听
        document.querySelectorAll('.delete-adjacent').forEach(btn => {
            btn.addEventListener('click', function () {
                const adjacent = this.getAttribute('data-adjacent');
                deleteConnection(areaName, adjacent);
            });
        });
    }

    // 添加新区域
    function addNewArea() {
        const name = areaNameInput.value.trim();
        if (!name) {
            alert('请输入区域名称');
            return;
        }

        if (mapData[name]) {
            alert('区域名称已存在');
            return;
        }

        // 创建新区域
        mapData[name] = {
            "描述": areaDescInput.value,
            "相邻区域": [],
            "安全区域": areaSafetySelect.value === "true",
            "位置": {
                "x": Math.random() * (mapContainer.offsetWidth - 200) + 100,
                "y": Math.random() * (mapContainer.offsetHeight - 200) + 100
            },
            "NPC": []
        };

        // 重新渲染地图
        renderMap();
        updateJsonOutput();

        // 选择新区域
        selectArea(name);
    }

    // 更新区域
    function updateArea() {
        if (!selectedArea) {
            alert('请先选择一个区域');
            return;
        }

        const name = areaNameInput.value.trim();
        if (!name) {
            alert('区域名称不能为空');
            return;
        }

        // 如果名称改变了，需要更新数据结构
        if (name !== selectedArea) {
            // 检查新名称是否已存在
            if (mapData[name]) {
                alert('区域名称已存在');
                return;
            }

            // 更新所有相邻区域中的引用
            for (const area in mapData) {
                const index = mapData[area].相邻区域.indexOf(selectedArea);
                if (index !== -1) {
                    mapData[area].相邻区域[index] = name;
                }
            }

            // 移动数据到新键
            mapData[name] = mapData[selectedArea];
            delete mapData[selectedArea];

            selectedArea = name;
        }

        // 更新区域属性
        mapData[name].描述 = areaDescInput.value;
        mapData[name].安全区域 = areaSafetySelect.value === "true";

        // 重新渲染地图
        renderMap();
        updateJsonOutput();
    }

    // 删除区域
    function deleteArea() {
        if (!selectedArea) {
            alert('请先选择一个区域');
            return;
        }

        if (!confirm(`确定要删除区域"${selectedArea}"吗？`)) {
            return;
        }

        // 从所有相邻区域中移除引用
        for (const area in mapData) {
            const index = mapData[area].相邻区域.indexOf(selectedArea);
            if (index !== -1) {
                mapData[area].相邻区域.splice(index, 1);
            }
        }

        // 删除区域
        delete mapData[selectedArea];

        // 重置表单
        areaNameInput.value = '';
        areaDescInput.value = '';
        areaSafetySelect.value = 'true';
        npcListDiv.innerHTML = '';
        adjacentAreasDiv.innerHTML = '';
        selectedArea = null;

        // 重新渲染地图
        renderMap();
        updateJsonOutput();
    }

    // 切换连接模式
    function toggleConnectMode() {
        connectMode = !connectMode;
        connectStart = null;

        if (connectMode) {
            modeIndicator.textContent = '当前模式: 连接模式 - 请选择起点';
            modeIndicator.style.background = '#f1c40f';
        } else {
            modeIndicator.textContent = '当前模式: 查看模式';
            modeIndicator.style.background = '#2ecc71';
        }
    }

    // 创建连接
    function createConnection(start, end) {
        if (!mapData[start].相邻区域.includes(end)) {
            mapData[start].相邻区域.push(end);
        }

        if (!mapData[end].相邻区域.includes(start)) {
            mapData[end].相邻区域.push(start);
        }

        // 重新渲染地图
        renderMap();
        updateJsonOutput();

        // 更新相邻区域显示
        if (selectedArea === start || selectedArea === end) {
            updateAdjacentAreas(selectedArea);
        }
    }

    // 删除连接
    function deleteConnection(area1, area2) {
        const index1 = mapData[area1].相邻区域.indexOf(area2);
        if (index1 !== -1) {
            mapData[area1].相邻区域.splice(index1, 1);
        }

        const index2 = mapData[area2].相邻区域.indexOf(area1);
        if (index2 !== -1) {
            mapData[area2].相邻区域.splice(index2, 1);
        }

        // 重新渲染地图
        renderMap();
        updateJsonOutput();

        // 更新相邻区域显示
        updateAdjacentAreas(selectedArea);
    }

    // 添加NPC
    function addNpc() {
        if (!selectedArea) {
            alert('请先选择一个区域');
            return;
        }

        mapData[selectedArea].NPC.push({
            "名称": "新NPC",
            "类型": "NPC类型"
        });

        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // 删除NPC
    function deleteNpc(index) {
        if (!selectedArea) return;

        mapData[selectedArea].NPC.splice(index, 1);
        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // 更新NPC字段
    function updateNpcField(index, field, value) {
        if (!selectedArea) return;

        const fieldName = field === 'npc-name' ? '名称' : '类型';
        mapData[selectedArea].NPC[index][fieldName] = value;
        updateJsonOutput();
    }

    // 更新JSON输出
    function updateJsonOutput() {
        // 创建不含位置信息的副本
        const outputData = {};
        for (const area in mapData) {
            outputData[area] = {...mapData[area]};
            delete outputData[area].位置;
        }

        jsonOutputDiv.textContent = JSON.stringify({"地图": outputData}, null, 2);
    }

    // 导出配置
    function exportConfig() {
        const dataStr = JSON.stringify({"地图": mapData}, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'game_map.json';
        link.click();
    }

    // 触发导入
    function triggerImport() {
        document.getElementById('importFile').click();
    }

    // 导入配置
    function importConfig(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.地图) {
                    // 为导入的数据添加位置信息（如果缺失）
                    for (const area in importedData.地图) {
                        if (!importedData.地图[area].位置) {
                            importedData.地图[area].位置 = {
                                x: Math.random() * (mapContainer.offsetWidth - 200) + 100,
                                y: Math.random() * (mapContainer.offsetHeight - 200) + 100
                            };
                        }
                    }

                    mapData = importedData.地图;
                    renderMap();
                    updateJsonOutput();

                    // 重置选择
                    selectedArea = null;
                    areaNameInput.value = '';
                    areaDescInput.value = '';
                    areaSafetySelect.value = 'true';
                    npcListDiv.innerHTML = '';
                    adjacentAreasDiv.innerHTML = '';

                    alert('配置导入成功！');
                } else {
                    alert('无效的地图配置格式');
                }
            } catch (error) {
                alert('导入失败：' + error.message);
            }
        };
        reader.readAsText(file);

        // 重置文件输入
        event.target.value = '';
    }
</script>
</body>
</html>