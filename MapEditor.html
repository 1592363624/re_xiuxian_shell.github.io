<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™æ¸¸æˆåœ°å›¾ç¼–è¾‘å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            position: relative;
        }

        /* èƒŒæ™¯è£…é¥°å…ƒç´  */
        .background-decoration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
            }
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            padding: 0;
        }

        .editor-panel {
            width: 30%;
            min-width: 350px;
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            display: flex;
            flex-direction: column;
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            color: white;
        }

        h1, h2 {
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.5);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .btn-success {
            background: rgba(46, 204, 113, 0.3);
            border-color: rgba(46, 204, 113, 0.5);
        }

        .btn-success:hover {
            background: rgba(46, 204, 113, 0.5);
        }

        .map-node {
            position: absolute;
            min-width: 150px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: move;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            user-select: none;
        }

        .map-node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .safe-area {
            background: rgba(212, 237, 218, 0.3);
            border: 1px solid rgba(195, 230, 203, 0.5);
        }

        .danger-area {
            background: rgba(248, 215, 218, 0.3);
            border: 1px solid rgba(245, 198, 203, 0.5);
        }

        .node-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .node-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }

        .node-npcs {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
        }

        .connection {
            position: absolute;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.5);
            transform-origin: 0 0;
            z-index: 5;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 12px solid rgba(255, 255, 255, 0.7);
        }

        .npc-list {
            margin-top: 10px;
        }

        .npc-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .npc-item input {
            margin: 5px 0;
        }

        .tools {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tools button {
            flex: 1;
            min-width: 100px;
        }

        .mode-indicator {
            padding: 8px 15px;
            background: rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid rgba(241, 196, 15, 0.5);
            backdrop-filter: blur(5px);
        }

        .json-output {
            background: rgba(44, 62, 80, 0.4);
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 150px;
        }

        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .back-to-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            color: white;
            font-size: 20px;
            text-decoration: none;
        }

        .back-to-home:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .editor-panel {
                width: 100%;
                height: 40%;
                min-width: auto;
            }

            .tools {
                flex-direction: column;
            }

            .tools button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
<div class="background-decoration">
    <div class="floating-element" style="width: 100px; height: 100px; top: 10%; left: 10%;"></div>
    <div class="floating-element" style="width: 150px; height: 150px; bottom: 15%; right: 10%;"></div>
    <div class="floating-element" style="width: 80px; height: 80px; top: 40%; right: 20%;"></div>
</div>

<!-- è¿”å›é¦–é¡µæŒ‰é’® -->
<a href="index.html" class="back-to-home" title="è¿”å›é¦–é¡µ">ğŸ </a>

<div class="container">
    <div class="editor-panel">
        <h1>ğŸ—ºï¸ åœ°å›¾ç¼–è¾‘å™¨</h1>

        <div class="mode-indicator" id="modeIndicator">å½“å‰æ¨¡å¼: æŸ¥çœ‹æ¨¡å¼</div>

        <div class="editor-content">
            <div class="form-group">
                <label for="areaName">åŒºåŸŸåç§°:</label>
                <input type="text" id="areaName" placeholder="è¾“å…¥åŒºåŸŸåç§°">
            </div>

            <div class="form-group">
                <label for="areaDesc">åŒºåŸŸæè¿°:</label>
                <textarea id="areaDesc" placeholder="è¾“å…¥åŒºåŸŸæè¿°"></textarea>
            </div>

            <div class="form-group">
                <label for="areaSafety">å®‰å…¨åŒºåŸŸ:</label>
                <select id="areaSafety">
                    <option value="true">æ˜¯</option>
                    <option value="false">å¦</option>
                </select>
            </div>

            <div class="form-group">
                <label>NPCåˆ—è¡¨:</label>
                <div id="npcList" class="npc-list">
                    <!-- NPCé¡¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
                <button id="addNpcBtn" class="btn-success">æ·»åŠ NPC</button>
            </div>

            <div class="tools">
                <button id="addAreaBtn" class="btn-success">æ·»åŠ åŒºåŸŸ</button>
                <button id="updateAreaBtn">æ›´æ–°åŒºåŸŸ</button>
                <button id="deleteAreaBtn" class="btn-danger">åˆ é™¤åŒºåŸŸ</button>
                <button id="connectModeBtn">è¿æ¥æ¨¡å¼</button>
            </div>

            <div class="form-group">
                <label>ç›¸é‚»åŒºåŸŸ:</label>
                <div id="adjacentAreas">
                    <!-- ç›¸é‚»åŒºåŸŸå°†åŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>

            <h2>åœ°å›¾JSONé…ç½®</h2>
            <div id="jsonOutput" class="json-output"></div>

            <div class="tools">
                <button id="exportBtn">å¯¼å‡ºé…ç½®</button>
                <button id="importBtn">å¯¼å…¥é…ç½®</button>
                <input type="file" id="importFile" style="display: none;" accept=".json">
            </div>
        </div>
    </div>

    <div class="map-container" id="mapContainer">
        <!-- åœ°å›¾èŠ‚ç‚¹å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
</div>

<script>
    // åˆå§‹åœ°å›¾æ•°æ®
    let mapData = {
        "é’äº‘é•‡": {
            "æè¿°": "ä¸€ä¸ªå®é™çš„å°é•‡ï¼Œæ˜¯ä¿®ä»™è€…åˆå…¥ä»™é€”çš„ç¬¬ä¸€ç«™ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["é’äº‘å±±è„‰", "ç¿ ç«¹æ—"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 100, "y": 300},
            "NPC": [
                {"åç§°": "é•‡é•¿ç‹å¤§é”¤", "ç±»å‹": "ä»»åŠ¡å‘å¸ƒè€…"},
                {"åç§°": "è¯åº—è€æ¿æå¤§å¤«", "ç±»å‹": "å•†äºº"}
            ]
        },
        "é’äº‘å±±è„‰": {
            "æè¿°": "é’äº‘é•‡å‘¨è¾¹çš„å±±è„‰ï¼Œçµæ°”æµ“éƒï¼Œé€‚åˆåˆå­¦è€…ä¿®ç‚¼ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["é’äº‘é•‡", "ç¿ ç«¹æ—", "é»‘é£å¯¨"],
            "å®‰å…¨åŒºåŸŸ": false,
            "ä½ç½®": {"x": 300, "y": 200},
            "NPC": [
                {"åç§°": "é‡‡è¯äººå°äºŒ", "ç±»å‹": "ææ–™å•†äºº"}
            ]
        },
        "ç¿ ç«¹æ—": {
            "æè¿°": "ä¸€ç‰‡ç¿ ç»¿çš„ç«¹æ—ï¼Œç¯å¢ƒæ¸…å¹½ï¼Œæ˜¯ä¿®ç‚¼å¿ƒå¢ƒçš„å¥½åœ°æ–¹ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["é’äº‘é•‡", "é’äº‘å±±è„‰", "æ— åæ´åºœ"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 200, "y": 450},
            "NPC": [
                {"åç§°": "ç«¹ç¿", "ç±»å‹": "éšå£«"}
            ]
        },
        "é»‘é£å¯¨": {
            "æè¿°": "å±±è´¼ç›˜è¸ä¹‹åœ°ï¼Œå±é™©é‡é‡ï¼Œä½†æœºç¼˜ä¹Ÿå¤šã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["é’äº‘å±±è„‰", "è’å¤æˆ˜åœº"],
            "å®‰å…¨åŒºåŸŸ": false,
            "ä½ç½®": {"x": 500, "y": 150},
            "NPC": [
                {"åç§°": "é»‘é£å¯¨ä¸»", "ç±»å‹": "æ•Œå¯¹Boss"}
            ]
        },
        "æ— åæ´åºœ": {
            "æè¿°": "ä¸€å¤„å¤è€çš„æ´åºœï¼Œæ®è¯´è—æœ‰å‰äººç•™ä¸‹çš„å®ç‰©ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["ç¿ ç«¹æ—", "è’å¤æˆ˜åœº"],
            "å®‰å…¨åŒºåŸŸ": false,
            "ä½ç½®": {"x": 400, "y": 400},
            "NPC": [
                {"åç§°": "æ´åºœå®ˆæŠ¤è€…", "ç±»å‹": "ç²¾è‹±æ€ªç‰©"}
            ]
        },
        "è’å¤æˆ˜åœº": {
            "æè¿°": "è¿œå¤æ—¶æœŸä»™é­”å¤§æˆ˜çš„æˆ˜åœºï¼Œæ®‹ç•™ç€å¼ºå¤§çš„æ°”æ¯ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["é»‘é£å¯¨", "æ— åæ´åºœ", "å¤©å‰‘å®—"],
            "å®‰å…¨åŒºåŸŸ": false,
            "ä½ç½®": {"x": 700, "y": 300},
            "NPC": [
                {"åç§°": "æˆ˜åœºæ¸¸é­‚", "ç±»å‹": "æ™®é€šæ€ªç‰©"}
            ]
        },
        "å¤©å‰‘å®—": {
            "æè¿°": "æ­£é“ä¸‰å¤§å®—é—¨ä¹‹ä¸€ï¼Œå‰‘ä¿®åœ£åœ°ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["è’å¤æˆ˜åœº", "è¡€åˆ€é—¨"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 900, "y": 200},
            "NPC": [
                {"åç§°": "æŒé—¨å¤©å‰‘è€äºº", "ç±»å‹": "å®—é—¨æŒé—¨"},
                {"åç§°": "å‰‘ä¾", "ç±»å‹": "å®—é—¨å®ˆå«"}
            ]
        },
        "è¡€åˆ€é—¨": {
            "æè¿°": "é­”é“ä¸‰å¤§å®—é—¨ä¹‹ä¸€ï¼Œä»¥åˆ€æ³•å’Œè¡€ç¥­é—»åã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["å¤©å‰‘å®—", "ä¸‡æ¯’é—¨"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 1100, "y": 350},
            "NPC": [
                {"åç§°": "é—¨ä¸»è¡€æ— æ¶¯", "ç±»å‹": "å®—é—¨æŒé—¨"}
            ]
        },
        "ä¸‡æ¯’é—¨": {
            "æè¿°": "é‚ªé“å®—é—¨ï¼Œä¸“ç²¾æ¯’ç‰©å’Œè›Šæœ¯ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["è¡€åˆ€é—¨", "æ˜†ä»‘ä»™å¢ƒ"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 900, "y": 500},
            "NPC": [
                {"åç§°": "åœ£å¥³æ¯’ä»™å­", "ç±»å‹": "å®—é—¨åœ£å¥³"}
            ]
        },
        "æ˜†ä»‘ä»™å¢ƒ": {
            "æè¿°": "ä¼ è¯´ä¸­çš„ä»™ç•Œå…¥å£ï¼Œåªæœ‰è¾¾åˆ°ä¸€å®šå¢ƒç•Œæ‰èƒ½è¿›å…¥ã€‚",
            "ç›¸é‚»åŒºåŸŸ": ["ä¸‡æ¯’é—¨"],
            "å®‰å…¨åŒºåŸŸ": true,
            "ä½ç½®": {"x": 1100, "y": 600},
            "NPC": [
                {"åç§°": "ä»™ç«¥", "ç±»å‹": "ä»™äºº"}
            ]
        }
    };

    // å½“å‰é€‰ä¸­çš„åŒºåŸŸ
    let selectedArea = null;
    // è¿æ¥æ¨¡å¼çŠ¶æ€
    let connectMode = false;
    // è¿æ¥èµ·ç‚¹
    let connectStart = null;

    // DOMå…ƒç´ 
    const mapContainer = document.getElementById('mapContainer');
    const areaNameInput = document.getElementById('areaName');
    const areaDescInput = document.getElementById('areaDesc');
    const areaSafetySelect = document.getElementById('areaSafety');
    const npcListDiv = document.getElementById('npcList');
    const adjacentAreasDiv = document.getElementById('adjacentAreas');
    const jsonOutputDiv = document.getElementById('jsonOutput');
    const modeIndicator = document.getElementById('modeIndicator');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        renderMap();
        updateJsonOutput();

        // äº‹ä»¶ç›‘å¬
        document.getElementById('addAreaBtn').addEventListener('click', addNewArea);
        document.getElementById('updateAreaBtn').addEventListener('click', updateArea);
        document.getElementById('deleteAreaBtn').addEventListener('click', deleteArea);
        document.getElementById('connectModeBtn').addEventListener('click', toggleConnectMode);
        document.getElementById('addNpcBtn').addEventListener('click', addNpc);
        document.getElementById('exportBtn').addEventListener('click', exportConfig);
        document.getElementById('importBtn').addEventListener('click', triggerImport);
        document.getElementById('importFile').addEventListener('change', importConfig);

        // åˆ›å»ºæ›´å¤šæµ®åŠ¨å…ƒç´ 
        createFloatingElements();
    });

    // åˆ›å»ºæ›´å¤šæµ®åŠ¨å…ƒç´ 
    function createFloatingElements() {
        const decoration = document.querySelector('.background-decoration');
        for (let i = 0; i < 5; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.style.width = Math.random() * 60 + 20 + 'px';
            element.style.height = element.style.width;
            element.style.top = Math.random() * 100 + '%';
            element.style.left = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 5 + 's';
            element.style.opacity = Math.random() * 0.1 + 0.05;
            decoration.appendChild(element);
        }
    }

    // æ¸²æŸ“åœ°å›¾
    function renderMap() {
        // æ¸…ç©ºåœ°å›¾å®¹å™¨
        mapContainer.innerHTML = '';

        // å…ˆç»˜åˆ¶è¿æ¥çº¿
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.ç›¸é‚»åŒºåŸŸ) {
                area.ç›¸é‚»åŒºåŸŸ.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].ä½ç½®) {
                        drawConnection(area.ä½ç½®, mapData[adjacent].ä½ç½®, areaName, adjacent);
                    }
                });
            }
        }

        // å†ç»˜åˆ¶åŒºåŸŸèŠ‚ç‚¹
        for (const areaName in mapData) {
            const area = mapData[areaName];
            createAreaNode(areaName, area);
        }
    }

    // åˆ›å»ºåŒºåŸŸèŠ‚ç‚¹
    function createAreaNode(name, data) {
        const node = document.createElement('div');
        node.className = `map-node ${data.å®‰å…¨åŒºåŸŸ ? 'safe-area' : 'danger-area'}`;
        node.style.left = `${data.ä½ç½®.x}px`;
        node.style.top = `${data.ä½ç½®.y}px`;
        node.setAttribute('data-name', name);
        node.setAttribute('draggable', 'true');

        node.innerHTML = `
                <div class="node-name">${name}</div>
                <div class="node-desc">${data.æè¿°}</div>
                <div class="node-npcs">${data.NPC.length}ä¸ªNPC</div>
            `;

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        node.addEventListener('click', function (e) {
            e.stopPropagation();
            selectArea(name);

            // å¦‚æœåœ¨è¿æ¥æ¨¡å¼ï¼Œå¤„ç†è¿æ¥
            if (connectMode) {
                if (connectStart === null) {
                    connectStart = name;
                    modeIndicator.textContent = `å½“å‰æ¨¡å¼: è¿æ¥æ¨¡å¼ - å·²é€‰æ‹©èµ·ç‚¹: ${name}`;
                } else {
                    if (connectStart !== name) {
                        createConnection(connectStart, name);
                    }
                    connectStart = null;
                    modeIndicator.textContent = 'å½“å‰æ¨¡å¼: è¿æ¥æ¨¡å¼ - è¯·é€‰æ‹©èµ·ç‚¹';
                }
            }
        });

        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        makeDraggable(node, name);

        mapContainer.appendChild(node);
    }

    // ä½¿èŠ‚ç‚¹å¯æ‹–æ‹½
    function makeDraggable(element, areaName) {
        let isDragging = false;
        let offsetX, offsetY;

        element.addEventListener('mousedown', function (e) {
            isDragging = true;
            offsetX = e.clientX - element.getBoundingClientRect().left;
            offsetY = e.clientY - element.getBoundingClientRect().top;
            element.style.zIndex = "100";
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;

            const mapRect = mapContainer.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();

            let x = e.clientX - mapRect.left - offsetX;
            let y = e.clientY - mapRect.top - offsetY;

            // é™åˆ¶æ‹–æ‹½èŒƒå›´
            x = Math.max(0, Math.min(x, mapRect.width - elementRect.width));
            y = Math.max(0, Math.min(y, mapRect.height - elementRect.height));

            element.style.left = x + 'px';
            element.style.top = y + 'px';

            // æ›´æ–°æ•°æ®
            mapData[areaName].ä½ç½®.x = x;
            mapData[areaName].ä½ç½®.y = y;

            // æ›´æ–°è¿æ¥çº¿
            updateConnections();
        });

        document.addEventListener('mouseup', function () {
            if (isDragging) {
                isDragging = false;
                element.style.zIndex = "10";
                updateJsonOutput();
            }
        });
    }

    // ç»˜åˆ¶è¿æ¥çº¿
    function drawConnection(startPos, endPos, startName, endName) {
        // è®¡ç®—è¿çº¿é•¿åº¦å’Œè§’åº¦
        const dx = endPos.x - startPos.x;
        const dy = endPos.y - startPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

        // åˆ›å»ºè¿çº¿
        const connection = document.createElement('div');
        connection.className = 'connection';
        connection.style.width = `${length}px`;
        connection.style.left = `${startPos.x}px`;
        connection.style.top = `${startPos.y}px`;
        connection.style.transform = `rotate(${angle}deg)`;

        // åˆ›å»ºç®­å¤´
        const arrow = document.createElement('div');
        arrow.className = 'connection-arrow';
        arrow.style.left = `${length - 5}px`;
        arrow.style.top = `-4px`;
        arrow.style.transform = `rotate(${angle}deg)`;

        connection.appendChild(arrow);
        connection.setAttribute('data-connection', `${startName}-${endName}`);
        mapContainer.appendChild(connection);
    }

    // æ›´æ–°æ‰€æœ‰è¿æ¥çº¿
    function updateConnections() {
        // ç§»é™¤æ‰€æœ‰ç°æœ‰è¿æ¥çº¿
        document.querySelectorAll('.connection').forEach(conn => {
            conn.remove();
        });

        // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è¿æ¥çº¿
        for (const areaName in mapData) {
            const area = mapData[areaName];
            if (area.ç›¸é‚»åŒºåŸŸ) {
                area.ç›¸é‚»åŒºåŸŸ.forEach(adjacent => {
                    if (mapData[adjacent] && mapData[adjacent].ä½ç½®) {
                        drawConnection(area.ä½ç½®, mapData[adjacent].ä½ç½®, areaName, adjacent);
                    }
                });
            }
        }
    }

    // é€‰æ‹©åŒºåŸŸ
    function selectArea(name) {
        selectedArea = name;
        const area = mapData[name];

        // æ›´æ–°è¡¨å•
        areaNameInput.value = name;
        areaDescInput.value = area.æè¿°;
        areaSafetySelect.value = area.å®‰å…¨åŒºåŸŸ;

        // æ›´æ–°NPCåˆ—è¡¨
        updateNpcList(area.NPC);

        // æ›´æ–°ç›¸é‚»åŒºåŸŸæ˜¾ç¤º
        updateAdjacentAreas(name);

        // é«˜äº®é€‰ä¸­çš„èŠ‚ç‚¹
        document.querySelectorAll('.map-node').forEach(node => {
            node.style.boxShadow = node.getAttribute('data-name') === name ?
                '0 0 0 3px #3498db, 0 0 15px rgba(52, 152, 219, 0.7)' : '0 4px 15px rgba(0, 0, 0, 0.2)';
        });
    }

    // æ›´æ–°NPCåˆ—è¡¨æ˜¾ç¤º
    function updateNpcList(npcs) {
        npcListDiv.innerHTML = '';

        npcs.forEach((npc, index) => {
            const npcItem = document.createElement('div');
            npcItem.className = 'npc-item';
            npcItem.innerHTML = `
                    <div>åç§°: <input type="text" value="${npc.åç§°}" data-index="${index}" class="npc-name"></div>
                    <div>ç±»å‹: <input type="text" value="${npc.ç±»å‹}" data-index="${index}" class="npc-type"></div>
                    <button class="btn-danger delete-npc" data-index="${index}">åˆ é™¤</button>
                `;
            npcListDiv.appendChild(npcItem);
        });

        // æ·»åŠ åˆ é™¤NPCçš„äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-npc').forEach(btn => {
            btn.addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                deleteNpc(index);
            });
        });

        // æ·»åŠ NPCå­—æ®µæ›´æ”¹çš„äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.npc-name, .npc-type').forEach(input => {
            input.addEventListener('change', function () {
                const index = parseInt(this.getAttribute('data-index'));
                updateNpcField(index, this.className, this.value);
            });
        });
    }

    // æ›´æ–°ç›¸é‚»åŒºåŸŸæ˜¾ç¤º
    function updateAdjacentAreas(areaName) {
        adjacentAreasDiv.innerHTML = '';
        const area = mapData[areaName];

        area.ç›¸é‚»åŒºåŸŸ.forEach(adjacent => {
            const adjItem = document.createElement('div');
            adjItem.className = 'npc-item';
            adjItem.innerHTML = `
                    <span>${adjacent}</span>
                    <button class="btn-danger delete-adjacent" data-adjacent="${adjacent}">åˆ é™¤è¿æ¥</button>
                `;
            adjacentAreasDiv.appendChild(adjItem);
        });

        // æ·»åŠ åˆ é™¤ç›¸é‚»åŒºåŸŸçš„äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-adjacent').forEach(btn => {
            btn.addEventListener('click', function () {
                const adjacent = this.getAttribute('data-adjacent');
                deleteConnection(areaName, adjacent);
            });
        });
    }

    // æ·»åŠ æ–°åŒºåŸŸ
    function addNewArea() {
        const name = areaNameInput.value.trim();
        if (!name) {
            alert('è¯·è¾“å…¥åŒºåŸŸåç§°');
            return;
        }

        if (mapData[name]) {
            alert('åŒºåŸŸåç§°å·²å­˜åœ¨');
            return;
        }

        // åˆ›å»ºæ–°åŒºåŸŸ
        mapData[name] = {
            "æè¿°": areaDescInput.value,
            "ç›¸é‚»åŒºåŸŸ": [],
            "å®‰å…¨åŒºåŸŸ": areaSafetySelect.value === "true",
            "ä½ç½®": {
                "x": Math.random() * (mapContainer.offsetWidth - 200) + 100,
                "y": Math.random() * (mapContainer.offsetHeight - 200) + 100
            },
            "NPC": []
        };

        // é‡æ–°æ¸²æŸ“åœ°å›¾
        renderMap();
        updateJsonOutput();

        // é€‰æ‹©æ–°åŒºåŸŸ
        selectArea(name);
    }

    // æ›´æ–°åŒºåŸŸ
    function updateArea() {
        if (!selectedArea) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŒºåŸŸ');
            return;
        }

        const name = areaNameInput.value.trim();
        if (!name) {
            alert('åŒºåŸŸåç§°ä¸èƒ½ä¸ºç©º');
            return;
        }

        // å¦‚æœåç§°æ”¹å˜äº†ï¼Œéœ€è¦æ›´æ–°æ•°æ®ç»“æ„
        if (name !== selectedArea) {
            // æ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
            if (mapData[name]) {
                alert('åŒºåŸŸåç§°å·²å­˜åœ¨');
                return;
            }

            // æ›´æ–°æ‰€æœ‰ç›¸é‚»åŒºåŸŸä¸­çš„å¼•ç”¨
            for (const area in mapData) {
                const index = mapData[area].ç›¸é‚»åŒºåŸŸ.indexOf(selectedArea);
                if (index !== -1) {
                    mapData[area].ç›¸é‚»åŒºåŸŸ[index] = name;
                }
            }

            // ç§»åŠ¨æ•°æ®åˆ°æ–°é”®
            mapData[name] = mapData[selectedArea];
            delete mapData[selectedArea];

            selectedArea = name;
        }

        // æ›´æ–°åŒºåŸŸå±æ€§
        mapData[name].æè¿° = areaDescInput.value;
        mapData[name].å®‰å…¨åŒºåŸŸ = areaSafetySelect.value === "true";

        // é‡æ–°æ¸²æŸ“åœ°å›¾
        renderMap();
        updateJsonOutput();
    }

    // åˆ é™¤åŒºåŸŸ
    function deleteArea() {
        if (!selectedArea) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŒºåŸŸ');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤åŒºåŸŸ"${selectedArea}"å—ï¼Ÿ`)) {
            return;
        }

        // ä»æ‰€æœ‰ç›¸é‚»åŒºåŸŸä¸­ç§»é™¤å¼•ç”¨
        for (const area in mapData) {
            const index = mapData[area].ç›¸é‚»åŒºåŸŸ.indexOf(selectedArea);
            if (index !== -1) {
                mapData[area].ç›¸é‚»åŒºåŸŸ.splice(index, 1);
            }
        }

        // åˆ é™¤åŒºåŸŸ
        delete mapData[selectedArea];

        // é‡ç½®è¡¨å•
        areaNameInput.value = '';
        areaDescInput.value = '';
        areaSafetySelect.value = 'true';
        npcListDiv.innerHTML = '';
        adjacentAreasDiv.innerHTML = '';
        selectedArea = null;

        // é‡æ–°æ¸²æŸ“åœ°å›¾
        renderMap();
        updateJsonOutput();
    }

    // åˆ‡æ¢è¿æ¥æ¨¡å¼
    function toggleConnectMode() {
        connectMode = !connectMode;
        connectStart = null;

        if (connectMode) {
            modeIndicator.textContent = 'å½“å‰æ¨¡å¼: è¿æ¥æ¨¡å¼ - è¯·é€‰æ‹©èµ·ç‚¹';
            modeIndicator.style.background = 'rgba(241, 196, 15, 0.3)';
        } else {
            modeIndicator.textContent = 'å½“å‰æ¨¡å¼: æŸ¥çœ‹æ¨¡å¼';
            modeIndicator.style.background = 'rgba(46, 204, 113, 0.3)';
        }
    }

    // åˆ›å»ºè¿æ¥
    function createConnection(start, end) {
        if (!mapData[start].ç›¸é‚»åŒºåŸŸ.includes(end)) {
            mapData[start].ç›¸é‚»åŒºåŸŸ.push(end);
        }

        if (!mapData[end].ç›¸é‚»åŒºåŸŸ.includes(start)) {
            mapData[end].ç›¸é‚»åŒºåŸŸ.push(start);
        }

        // é‡æ–°æ¸²æŸ“åœ°å›¾
        renderMap();
        updateJsonOutput();

        // æ›´æ–°ç›¸é‚»åŒºåŸŸæ˜¾ç¤º
        if (selectedArea === start || selectedArea === end) {
            updateAdjacentAreas(selectedArea);
        }
    }

    // åˆ é™¤è¿æ¥
    function deleteConnection(area1, area2) {
        const index1 = mapData[area1].ç›¸é‚»åŒºåŸŸ.indexOf(area2);
        if (index1 !== -1) {
            mapData[area1].ç›¸é‚»åŒºåŸŸ.splice(index1, 1);
        }

        const index2 = mapData[area2].ç›¸é‚»åŒºåŸŸ.indexOf(area1);
        if (index2 !== -1) {
            mapData[area2].ç›¸é‚»åŒºåŸŸ.splice(index2, 1);
        }

        // é‡æ–°æ¸²æŸ“åœ°å›¾
        renderMap();
        updateJsonOutput();

        // æ›´æ–°ç›¸é‚»åŒºåŸŸæ˜¾ç¤º
        updateAdjacentAreas(selectedArea);
    }

    // æ·»åŠ NPC
    function addNpc() {
        if (!selectedArea) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŒºåŸŸ');
            return;
        }

        mapData[selectedArea].NPC.push({
            "åç§°": "æ–°NPC",
            "ç±»å‹": "NPCç±»å‹"
        });

        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // åˆ é™¤NPC
    function deleteNpc(index) {
        if (!selectedArea) return;

        mapData[selectedArea].NPC.splice(index, 1);
        updateNpcList(mapData[selectedArea].NPC);
        updateJsonOutput();
    }

    // æ›´æ–°NPCå­—æ®µ
    function updateNpcField(index, field, value) {
        if (!selectedArea) return;

        const fieldName = field === 'npc-name' ? 'åç§°' : 'ç±»å‹';
        mapData[selectedArea].NPC[index][fieldName] = value;
        updateJsonOutput();
    }

    // æ›´æ–°JSONè¾“å‡º
    function updateJsonOutput() {
        // åˆ›å»ºä¸å«ä½ç½®ä¿¡æ¯çš„å‰¯æœ¬
        const outputData = {};
        for (const area in mapData) {
            outputData[area] = {...mapData[area]};
            delete outputData[area].ä½ç½®;
        }

        jsonOutputDiv.textContent = JSON.stringify({"åœ°å›¾": outputData}, null, 2);
    }

    // å¯¼å‡ºé…ç½®
    function exportConfig() {
        const dataStr = JSON.stringify({"åœ°å›¾": mapData}, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'game_map.json';
        link.click();
    }

    // è§¦å‘å¯¼å…¥
    function triggerImport() {
        document.getElementById('importFile').click();
    }

    // å¯¼å…¥é…ç½®
    function importConfig(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.åœ°å›¾) {
                    // ä¸ºå¯¼å…¥çš„æ•°æ®æ·»åŠ ä½ç½®ä¿¡æ¯ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
                    for (const area in importedData.åœ°å›¾) {
                        if (!importedData.åœ°å›¾[area].ä½ç½®) {
                            importedData.åœ°å›¾[area].ä½ç½® = {
                                x: Math.random() * (mapContainer.offsetWidth - 200) + 100,
                                y: Math.random() * (mapContainer.offsetHeight - 200) + 100
                            };
                        }
                    }

                    mapData = importedData.åœ°å›¾;
                    renderMap();
                    updateJsonOutput();

                    // é‡ç½®é€‰æ‹©
                    selectedArea = null;
                    areaNameInput.value = '';
                    areaDescInput.value = '';
                    areaSafetySelect.value = 'true';
                    npcListDiv.innerHTML = '';
                    adjacentAreasDiv.innerHTML = '';

                    alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                } else {
                    alert('æ— æ•ˆçš„åœ°å›¾é…ç½®æ ¼å¼');
                }
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
            }
        };
        reader.readAsText(file);

        // é‡ç½®æ–‡ä»¶è¾“å…¥
        event.target.value = '';
    }
</script>
</body>
</html>